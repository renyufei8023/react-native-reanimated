"use strict";(self.webpackChunkdocs_worklets=self.webpackChunkdocs_worklets||[]).push([[3271],{5758:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>B,contentTitle:()=>z,default:()=>W,frontMatter:()=>Y,metadata:()=>s,toc:()=>X});const s=JSON.parse('{"id":"threading/runOnJS","title":"runOnJS","description":"runOnJS lets you asynchronously run non-workletized functions that couldn\'t otherwise run on the UI thread. This applies to most external libraries as they don\'t have their functions marked with \\"worklet\\"; directive.","source":"@site/docs/threading/runOnJS.mdx","sourceDirName":"threading","slug":"/threading/runOnJS","permalink":"/react-native-worklets/docs/threading/runOnJS","draft":false,"unlisted":false,"editUrl":"https://github.com/software-mansion/react-native-reanimated/edit/main/packages/docs-worklets/docs/threading/runOnJS.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Threading","permalink":"/react-native-worklets/docs/category/threading"},"next":{"title":"runOnUI","permalink":"/react-native-worklets/docs/threading/runOnUI"}}');var r=t(7671),i=t(620),a=t(9471),o=t(8589),l=t(1721),c=t(8549),u=t(4436),d=t(2901),h="DELAY",_="ERROR",f="LONG_PRESS_DETECTED",m="NOT_RESPONDER",E="RESPONDER_ACTIVE_LONG_PRESS_START",g="RESPONDER_ACTIVE_PRESS_START",p="RESPONDER_INACTIVE_PRESS_START",S="RESPONDER_RELEASE",v="RESPONDER_TERMINATED",R=Object.freeze({NOT_RESPONDER:{DELAY:_,RESPONDER_GRANT:p,RESPONDER_RELEASE:_,RESPONDER_TERMINATED:_,LONG_PRESS_DETECTED:_},RESPONDER_INACTIVE_PRESS_START:{DELAY:g,RESPONDER_GRANT:_,RESPONDER_RELEASE:m,RESPONDER_TERMINATED:m,LONG_PRESS_DETECTED:_},RESPONDER_ACTIVE_PRESS_START:{DELAY:_,RESPONDER_GRANT:_,RESPONDER_RELEASE:m,RESPONDER_TERMINATED:m,LONG_PRESS_DETECTED:E},RESPONDER_ACTIVE_LONG_PRESS_START:{DELAY:_,RESPONDER_GRANT:_,RESPONDER_RELEASE:m,RESPONDER_TERMINATED:m,LONG_PRESS_DETECTED:E},ERROR:{DELAY:m,RESPONDER_GRANT:p,RESPONDER_RELEASE:m,RESPONDER_TERMINATED:m,LONG_PRESS_DETECTED:m}}),P=e=>e===g||e===E,y=e=>"button"===e.getAttribute("role"),T=e=>e===p||e===g||e===E,x=e=>{var n=e.key,t=e.target.getAttribute("role");return"Enter"===n||(" "===n||"Spacebar"===n)&&"button"===t};class D{constructor(e){this._eventHandlers=null,this._isPointerTouch=!1,this._longPressDelayTimeout=null,this._longPressDispatched=!1,this._pressDelayTimeout=null,this._pressOutDelayTimeout=null,this._touchState=m,this.configure(e)}configure(e){this._config=e}reset(){this._cancelLongPressDelayTimeout(),this._cancelPressDelayTimeout(),this._cancelPressOutDelayTimeout()}getEventHandlers(){return null==this._eventHandlers&&(this._eventHandlers=this._createEventHandlers()),this._eventHandlers}_createEventHandlers(){var e=(e,n)=>{e.persist(),this._cancelPressOutDelayTimeout(),this._longPressDispatched=!1,this._selectionTerminated=!1,this._touchState=m,this._isPointerTouch="touchstart"===e.nativeEvent.type,this._receiveSignal("RESPONDER_GRANT",e);var t=O(this._config.delayPressStart,0,50);!1!==n&&t>0?this._pressDelayTimeout=setTimeout((()=>{this._receiveSignal(h,e)}),t):this._receiveSignal(h,e);var s=O(this._config.delayLongPress,10,450);this._longPressDelayTimeout=setTimeout((()=>{this._handleLongPress(e)}),s+t)},n=e=>{this._receiveSignal(S,e)},t=e=>{var s=this._config.onPress,r=e.target;if(this._touchState!==m&&x(e)){n(e),document.removeEventListener("keyup",t);var i=r.getAttribute("role"),a=r.tagName.toLowerCase();null==s||("link"===i||"a"===a||"button"===a||"input"===a||"select"===a||"textarea"===a)||s(e)}};return{onStartShouldSetResponder:e=>{var n=this._config.disabled;return n&&y(e.currentTarget)&&e.stopPropagation(),null==n||!n},onKeyDown:n=>{var s=this._config.disabled,r=n.key,i=n.target;if(!s&&x(n)){this._touchState===m&&(e(n,!1),document.addEventListener("keyup",t));var a=i.getAttribute("role");(" "===r||"Spacebar"===r)&&("button"===a||"menuitem"===a)&&n.preventDefault(),n.stopPropagation()}},onResponderGrant:n=>e(n),onResponderMove:e=>{null!=this._config.onPressMove&&this._config.onPressMove(e);var n=b(e);if(null!=this._touchActivatePosition){var t=this._touchActivatePosition.pageX-n.pageX,s=this._touchActivatePosition.pageY-n.pageY;Math.hypot(t,s)>10&&this._cancelLongPressDelayTimeout()}},onResponderRelease:e=>n(e),onResponderTerminate:e=>{"selectionchange"===e.nativeEvent.type&&(this._selectionTerminated=!0),this._receiveSignal(v,e)},onResponderTerminationRequest:e=>{var n=this._config,t=n.cancelable,s=n.disabled,r=n.onLongPress;return!(!s&&null!=r&&this._isPointerTouch&&"contextmenu"===e.nativeEvent.type)&&(null==t||t)},onClick:e=>{var n=this._config,t=n.disabled,s=n.onPress;t?y(e.currentTarget)&&e.stopPropagation():(e.stopPropagation(),this._longPressDispatched||this._selectionTerminated?e.preventDefault():null!=s&&!1===e.altKey&&s(e))},onContextMenu:e=>{var n=this._config,t=n.disabled,s=n.onLongPress;t?y(e.currentTarget)&&e.stopPropagation():null!=s&&this._isPointerTouch&&!e.defaultPrevented&&(e.preventDefault(),e.stopPropagation())}}}_receiveSignal(e,n){var t=this._touchState,s=null;null!=R[t]&&(s=R[t][e]),this._touchState===m&&e===S||(null==s||s===_?console.error("PressResponder: Invalid signal "+e+" for state "+t+" on responder"):t!==s&&(this._performTransitionSideEffects(t,s,e,n),this._touchState=s))}_performTransitionSideEffects(e,n,t,s){if((e=>e===v||e===S)(t)&&(setTimeout((()=>{this._isPointerTouch=!1}),0),this._touchActivatePosition=null,this._cancelLongPressDelayTimeout()),T(e)&&t===f){var r=this._config.onLongPress;null!=r&&null==s.nativeEvent.key&&(r(s),this._longPressDispatched=!0)}var i=P(e),a=P(n);if(!i&&a?this._activate(s):i&&!a&&this._deactivate(s),T(e)&&t===S){var o=this._config,l=o.onLongPress;if(null!=o.onPress)null!=l&&e===E||a||i||(this._activate(s),this._deactivate(s))}this._cancelPressDelayTimeout()}_activate(e){var n=this._config,t=n.onPressChange,s=n.onPressStart,r=b(e);this._touchActivatePosition={pageX:r.pageX,pageY:r.pageY},null!=s&&s(e),null!=t&&t(!0)}_deactivate(e){var n=this._config,t=n.onPressChange,s=n.onPressEnd;function r(){null!=s&&s(e),null!=t&&t(!1)}var i=O(this._config.delayPressEnd);i>0?this._pressOutDelayTimeout=setTimeout((()=>{r()}),i):r()}_handleLongPress(e){this._touchState!==g&&this._touchState!==E||this._receiveSignal(f,e)}_cancelLongPressDelayTimeout(){null!=this._longPressDelayTimeout&&(clearTimeout(this._longPressDelayTimeout),this._longPressDelayTimeout=null)}_cancelPressDelayTimeout(){null!=this._pressDelayTimeout&&(clearTimeout(this._pressDelayTimeout),this._pressDelayTimeout=null)}_cancelPressOutDelayTimeout(){null!=this._pressOutDelayTimeout&&(clearTimeout(this._pressOutDelayTimeout),this._pressOutDelayTimeout=null)}}function O(e,n,t){return void 0===n&&(n=0),void 0===t&&(t=0),Math.max(n,null!=e?e:t)}function b(e){var n=e.nativeEvent,t=n.changedTouches,s=n.touches;return null!=s&&s.length>0?s[0]:null!=t&&t.length>0?t[0]:e.nativeEvent}var A=["activeOpacity","delayPressIn","delayPressOut","delayLongPress","disabled","focusable","onLongPress","onPress","onPressIn","onPressOut","rejectResponderTermination","style"];function j(e,n){var t=e.activeOpacity,s=e.delayPressIn,r=e.delayPressOut,i=e.delayLongPress,l=e.disabled,h=e.focusable,_=e.onLongPress,f=e.onPress,m=e.onPressIn,E=e.onPressOut,g=e.rejectResponderTermination,p=e.style,S=(0,u.A)(e,A),v=(0,a.useRef)(null),R=(0,d.A)(n,v),P=(0,a.useState)("0s"),y=P[0],T=P[1],x=(0,a.useState)(null),O=x[0],b=x[1],j=(0,a.useCallback)(((e,n)=>{b(e),T(n?n/1e3+"s":"0s")}),[b,T]),k=(0,a.useCallback)((e=>{j(null!=t?t:.2,e)}),[t,j]),w=(0,a.useCallback)((e=>{j(null,e)}),[j]),L=function(e,n){var t=(0,a.useRef)(null);null==t.current&&(t.current=new D(n));var s=t.current;return(0,a.useEffect)((()=>{s.configure(n)}),[n,s]),(0,a.useEffect)((()=>()=>{s.reset()}),[s]),(0,a.useDebugValue)(n),s.getEventHandlers()}(0,(0,a.useMemo)((()=>({cancelable:!g,disabled:l,delayLongPress:i,delayPressStart:s,delayPressEnd:r,onLongPress:_,onPress:f,onPressStart(e){var n=null!=e.dispatchConfig?"onResponderGrant"===e.dispatchConfig.registrationName:"keydown"===e.type;k(n?0:150),null!=m&&m(e)},onPressEnd(e){w(250),null!=E&&E(e)}})),[i,s,r,l,_,f,m,E,g,k,w]));return a.createElement(o.A,(0,c.A)({},S,L,{accessibilityDisabled:l,focusable:!l&&!1!==h,pointerEvents:l?"none":void 0,ref:R,style:[N.root,!l&&N.actionable,p,null!=O&&{opacity:O},{transitionDuration:y}]}))}var N=l.A.create({root:{transitionProperty:"opacity",transitionDuration:"0.15s",userSelect:"none"},actionable:{cursor:"pointer",touchAction:"manipulation"}}),k=a.memo(a.forwardRef(j));k.displayName="TouchableOpacity";const w=k;var L=t(1071),I=a.forwardRef(((e,n)=>{var t=e.accessibilityLabel,s=e.color,r=e.disabled,i=e.onPress,o=e.testID,l=e.title;return a.createElement(w,{accessibilityLabel:t,accessibilityRole:"button",disabled:r,focusable:!r,onPress:i,ref:n,style:[J.button,s&&{backgroundColor:s},r&&J.buttonDisabled],testID:o},a.createElement(L.A,{style:[J.text,r&&J.textDisabled]},l))}));I.displayName="Button";var J=l.A.create({button:{backgroundColor:"#2196F3",borderRadius:2},text:{color:"#fff",fontWeight:"500",padding:8,textAlign:"center",textTransform:"uppercase"},buttonDisabled:{backgroundColor:"#dfdfdf"},textDisabled:{color:"#a1a1a1"}});const C=I;var V=t(9502);const G={code:"function RunOnJSTsx1(){const{runOnJS,setFinished}=this.__closure;runOnJS(setFinished)(true);}"},F={code:"function RunOnJSTsx2(){const{scale}=this.__closure;return{transform:[{scale:scale.value}]};}"};function M(){const e=(0,V.UAN)(1),[n,t]=a.useState(!1),s=(0,V.mPH)(function(e){let{_worklet_8738913883780_init_data:n,scale:t}=e;const s=()=>({transform:[{scale:t.value}]});return s.__closure={scale:t},s.__workletHash=8738913883780,s.__initData=n,s}({_worklet_8738913883780_init_data:F,scale:e}));return(0,r.jsxs)(o.A,{style:H.container,children:[(0,r.jsx)(V.Ay$.View,{style:[H.box,s]}),(0,r.jsx)(C,{onPress:()=>{e.value=(0,V.eky)(2,{},function(e){let{_worklet_7767882256352_init_data:n,runOnJS:t,setFinished:s}=e;const r=function(){t(s)(!0)};return r.__closure={runOnJS:t,setFinished:s},r.__workletHash=7767882256352,r.__initData=n,r}({_worklet_7767882256352_init_data:G,runOnJS:V.OGr,setFinished:t}))},title:"Click me",disabled:n}),n&&(0,r.jsx)(L.A,{children:"Finished! \ud83c\udf89"})]})}const H=l.A.create({container:{flex:1,alignItems:"center"},box:{height:100,width:100,backgroundColor:"#b58df1",borderRadius:20,marginVertical:64,alignSelf:"center"}}),U="import React from 'react';\nimport { Button, View, StyleSheet, Text } from 'react-native';\nimport Animated, {\n  useSharedValue,\n  withSpring,\n  runOnJS,\n} from 'react-native-reanimated';\nimport { useAnimatedStyle } from 'react-native-reanimated';\n\nexport default function App() {\n  const scale = useSharedValue<number>(1);\n  const [finished, setFinished] = React.useState<boolean>(false);\n\n  const handlePress = () => {\n    scale.value = withSpring(2, {}, () => {\n      // highlight-next-line\n      runOnJS(setFinished)(true);\n    });\n  };\n\n  const animatedStyle = useAnimatedStyle(() => ({\n    transform: [{ scale: scale.value }],\n  }));\n\n  return (\n    <View style={styles.container}>\n      <Animated.View style={[styles.box, animatedStyle]} />\n      <Button onPress={handlePress} title=\"Click me\" disabled={finished} />\n      {finished && <Text>Finished! \ud83c\udf89</Text>}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    alignItems: 'center',\n  },\n  box: {\n    height: 100,\n    width: 100,\n    backgroundColor: '#b58df1',\n    borderRadius: 20,\n    marginVertical: 64,\n    alignSelf: 'center',\n  },\n});\n",Y={sidebar_position:1},z="runOnJS",B={},X=[{value:"Reference",id:"reference",level:2},{value:"Arguments",id:"arguments",level:3},{value:"fn",id:"fn",level:4},{value:"Returns",id:"returns",level:3},{value:"Example",id:"example",level:2},{value:"Remarks",id:"remarks",level:2}];function K(e){const n={a:"a",admonition:"admonition",code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Details:t,Indent:s,InteractiveExample:a}=n;return t||q("Details",!0),s||q("Indent",!0),a||q("InteractiveExample",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"runonjs",children:"runOnJS"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"runOnJS"})," lets you asynchronously run non-",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#to-workletize",children:"workletized"})," functions that couldn't otherwise run on the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),". This applies to most external libraries as they don't have their functions marked with ",(0,r.jsx)(n.code,{children:'"worklet";'})," directive."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"runOnJS"})," is usually used to update React state either on animation finish or conditionally within a gesture."]}),"\n",(0,r.jsx)(n.h2,{id:"reference",children:"Reference"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"import { runOnJS } from 'react-native-reanimated';\n\nfunction App() {\n  // While on the UI thread\n  runOnJS(navigation.goBack)();\n}\n"})}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:"Type definitions"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function runOnJS<A extends any[], R>(\n  fn: (...args: A) => R\n): (...args: Parameters<typeof fn>) => void;\n"})})]}),"\n",(0,r.jsx)(n.h3,{id:"arguments",children:"Arguments"}),"\n",(0,r.jsx)(n.h4,{id:"fn",children:"fn"}),"\n",(0,r.jsxs)(n.p,{children:["A reference to a function you want to execute on the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"})," from the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),". Arguments to your function have to be passed to the function returned from ",(0,r.jsx)(n.code,{children:"runOnJS"})," i.e. ",(0,r.jsx)(n.code,{children:"runOnJS(setValue)(10);"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"returns",children:"Returns"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"runOnJS"})," returns a function that accepts arguments for the function passed as the first argument. This function can be safely executed on the UI thread."]}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.p,{children:["Don't forget to call the function returned from ",(0,r.jsx)(n.code,{children:"runOnJS"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"example",children:"Example"}),"\n","\n",(0,r.jsx)(a,{src:U,component:M}),"\n",(0,r.jsx)(n.h2,{id:"remarks",children:"Remarks"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Functions passed to ",(0,r.jsx)(n.code,{children:"runOnJS"})," must be defined in the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"})," scope, i.e. in the component body or the global scope. The code below won't work because ",(0,r.jsx)(n.code,{children:"myFunction"})," is defined in the ",(0,r.jsx)(n.code,{children:"withTiming"})," callback, which is only executed in the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),":"]}),"\n"]}),"\n",(0,r.jsx)(s,{children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",children:"withTiming(0, {}, () => {\n  // myFunction is defined on the UI thread \ud83d\udea8\n  const myFunction = () => {\n    // ...\n  };\n  runOnJS(myFunction)(); // \ud83d\udca5\n});\n"})})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["It's a common mistake to execute function inside of runOnJS like this: ",(0,r.jsx)(n.del,{children:(0,r.jsx)(n.code,{children:"runOnJS(setValue(10))()"})}),". Here, the correct usage would be ",(0,r.jsx)(n.code,{children:"runOnJS(setValue)(10)"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["It's safe to run functions via ",(0,r.jsx)(n.code,{children:"runOnJS"})," on the ",(0,r.jsx)(n.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"}),", as this has no effect."]}),"\n"]}),"\n"]})]})}function W(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(K,{...e})}):K(e)}function q(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);